package db

import (
	"context"

	"github.com/m-mizutani/goerr"
	"github.com/m-mizutani/octovy/pkg/infra/ent"
)

func (x *Client) PutVulnerabilities(ctx context.Context, vulnerabilities []*ent.Vulnerability) error {
	if x.lock {
		x.mutex.Lock()
		defer x.mutex.Unlock()
	}

	vulnBuilder := make([]*ent.VulnerabilityCreate, len(vulnerabilities))
	for i, vuln := range vulnerabilities {
		vulnBuilder[i] = x.client.Vulnerability.Create().
			SetID(vuln.ID).
			SetFirstSeenAt(vuln.FirstSeenAt).
			SetLastModifiedAt(vuln.LastModifiedAt).
			SetTitle(vuln.Title).
			SetDescription(vuln.Description).
			SetCweID(vuln.CweID).
			SetSeverity(vuln.Severity).
			SetCvss(vuln.Cvss).
			SetReferences(vuln.References)
	}

	if err := x.client.Vulnerability.CreateBulk(vulnBuilder...).OnConflict().UpdateNewValues().Exec(ctx); err != nil {
		return goerr.Wrap(err)
	}

	return nil
}
